<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
    <!-- Import style from static/common.css -->
    <link rel="stylesheet" href="/static/common.css">
    <title>Download AddGene kit info</title>
</head>

<body>
    <div class="container mx-auto col-6">
        <h1>Download AddGene kit info</h1>
        <p>This form allows you to download the list of plasmids contained in an AddGene kit, and
            save it as a tsv file. The tsv file can be used to submit the kit as a template using
            <a href="/">this form</a>.
        </p>
        <h2>How to use this form</h2>
        <ol>
            <li>Copy the url of an AddGene kit, for instance
                <a href="https://www.addgene.org/kits/moclo-ytk">https://www.addgene.org/kits/moclo-ytk</a>.
            </li>
            <li>Paste the url in the input field below.</li>
            <li>Click on the submit button.</li>
            <li>Wait for the table to load.</li>
            <li>Check that the table is correct (contains all plasmids of the kit).</li>
            <li>Click on the "Download as tsv" button to download the table as a tsv file.</li>
            <li>Use that file in the <a href="/">submission form</a> </li>
        </ol>
        <form class="form-group row g-3 align-items-center justify-content-center mt-2" id="main-form">
            <div class="col-auto">
                <input type="text" class="form-control" name="addgene-url" id="addgene-url"
                    placeholder="https://www.addgene.org/kits/...">
            </div>
            <div class="col-auto">
                <input id='submit-button' type="submit" class="btn btn-primary m-2" />
            </div>
        </form>
        <!-- Loading from server div, initially hidden -->
        <div id="loading" class="" hidden>
            <span class="spinner-border" role="status">

            </span>
            <span>Loading...</span>
        </div>
        <div class="download-button">
            <button hidden class="btn btn-success m-2 fs-2" id="download-button">Download tsv</button>
        </div>
        <div class="alert alert-danger" role="alert" hidden>
        </div>
        <div id="table-result">
        </div>
    </div>
    </div>
</body>

<footer>
    <script>
        async function makeHtmlTable(plasmids) {
            const table = document.createElement('table')
            table.classList.add('table')
            const headerRow = document.createElement('tr')
            const tableHeaders = ['well', 'plasmid_name', 'addgene_id', 'resistance']
            tableHeaders.forEach(header => {
                const th = document.createElement('th')
                th.innerText = header
                headerRow.appendChild(th)
            })
            table.appendChild(headerRow)
            plasmids.forEach(plasmid => {
                const row = document.createElement('tr')
                const well = document.createElement('td')
                well.innerText = plasmid.well
                const name = document.createElement('td')
                name.innerText = plasmid.name
                const addgene_id = document.createElement('td')
                addgene_id.innerText = plasmid.addgene_id
                const resistance = document.createElement('td')
                resistance.innerText = plasmid.resistance
                row.appendChild(well)
                row.appendChild(name)
                row.appendChild(addgene_id)
                row.appendChild(resistance)
                table.appendChild(row)
            })
            return table;
        }
        async function scrape() {
            // Get the scraped content using the backend
            const addgeneUrl = document.getElementById('addgene-url').value
            const response = await fetch(`/scrape_addgene?url=${addgeneUrl}`)
            if (!response.ok) {
                const responseJson = await response.json()
                throw new Error(responseJson.detail)
            }
            const htmlContent = await response.text()

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            // the last element (sometimes there is a table with only headers on top)
            const elements = doc.querySelectorAll('#kit-contents table.kit-inventory-table')
            const kitTable = elements[elements.length - 1]

            // Check that the headers of the table are Well, Plasmid and Resistance
            const headers = kitTable.querySelectorAll('thead th')
            if (headers.length !== 3) {
                alert('The html document does not have the expected structure')
                return
            }
            const headerText = Array.from(headers).map(header => header.innerText.trim())
            if (headerText[0] !== 'Well' || headerText[1] !== 'Plasmid' || headerText[2] !== 'Resistance') {
                alert('The table does not have the expected headers')
                return
            }
            console.log(kitTable)
            // Get the plasmid info
            const plasmids = Array.from(kitTable.querySelectorAll('tbody tr')).map(row => {
                const cells = row.querySelectorAll('td')
                const idHref = cells[1].querySelector('a').href.split('/')
                // For now, it seems that ids are /id/ (they have trailing slash)
                // But it is better to be safe and pop twice, since first pop will
                // be false if there is no trailing slash
                const addgene_id = idHref.pop() || idHref.pop()
                return {
                    well: cells[0].innerText.trim(),
                    name: cells[1].innerText.trim(),
                    addgene_id,
                    resistance: cells[2].innerText.trim()
                }
            })
            // Make an html table
            const table = await makeHtmlTable(plasmids)
            document.getElementById('table-result').appendChild(table)

            // Allow the user to download the table as tsv
            const downloadButton = document.getElementById('download-button')
            downloadButton.onclick = () => {
                let tsv = 'plasmid_name\taddgene_id\tcategory\tresistance\twell\tdescription\n'
                tsv += plasmids.map(plasmid => {
                    const { well, name, addgene_id, resistance } = plasmid
                    return [name, addgene_id, '', resistance, well, ''].join('\t')
                }).join('\n')
                const blob = new Blob([tsv], {
                    type: 'text/tsv'
                })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = 'plasmids.tsv'
                a.click()
                URL.revokeObjectURL(url)
            }
        }
        async function submitFunction(e) {
            e.preventDefault();
            const loading = document.getElementById('loading')
            const downloadButton = document.getElementById('download-button')
            const errorAlert = document.querySelector('.alert-danger')
            document.getElementById('table-result').innerHTML = ''
            try {
                errorAlert.hidden = true
                loading.hidden = false
                await scrape()
                downloadButton.hidden = false
            } catch (e) {
                errorAlert.hidden = false
                errorAlert.innerText = e
                downloadButton.hidden = true
            }
            finally {
                loading.hidden = true
            }
        }

        window.onload = () => {
            document
                .getElementById("main-form")
                .addEventListener("submit", submitFunction);
        };
    </script>
</footer>

</html>